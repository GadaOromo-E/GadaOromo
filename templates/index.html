<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Gada Oromo Dictionary</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div class="container">

  <header class="topbar">
    <div class="brand">
      <h1>Gada Oromo Dictionary</h1>
      <p class="tagline">Your global Oromo â†” English community dictionary</p>
    </div>
  </header>

  <nav class="nav">
    <a class="nav-link" href="/">Home</a>
    <a class="nav-link" href="/translate">Translate</a>
    <a class="nav-link" href="/submit">Submit Word</a>
    <a class="nav-link" href="/submit_phrase">Submit Phrase</a>
    <a class="nav-link" href="/admin">Admin</a>
  </nav>

  <section class="card">
    <h2>Search Dictionary</h2>

    <form method="POST" id="searchForm" class="row" style="align-items:stretch;">
      <input type="text" name="word" id="searchWord" placeholder="Type English or Oromo word..." required>
      <button type="button" onclick="startVoiceSearch()" title="Speak search">ğŸ¤</button>
      <button type="submit">Search</button>
    </form>

    <div class="subtle" style="margin-top:10px;">
      Tip: press ğŸ¤ and speak the word if you canâ€™t type.
    </div>

    {% if result %}
      <div class="result-box" style="margin-top:14px;">
        <div><b>English:</b> <span id="enText">{{ result[0] }}</span></div>
        <div style="margin-top:6px;"><b>Oromo:</b> <span id="omText">{{ result[1] }}</span></div>

        <!-- Priority: Community audio (real Oromo speakers) -->
        {% if audio and (audio.oromo or audio.english) %}
          <div style="margin-top:14px;">
            <div class="subtle">ğŸ§ Community pronunciation (admin approved)</div>

            {% if audio.oromo %}
              <div class="subtle" style="margin-top:10px;">Oromo audio</div>
              <audio controls style="width:100%;">
                <source src="{{ url_for('static', filename=audio.oromo) }}">
              </audio>
            {% endif %}

            {% if audio.english %}
              <div class="subtle" style="margin-top:10px;">English audio</div>
              <audio controls style="width:100%;">
                <source src="{{ url_for('static', filename=audio.english) }}">
              </audio>
            {% endif %}
          </div>
        {% else %}
          <div class="muted" style="margin-top:10px;">
            No approved community audio yet. You can help by uploading pronunciation below.
          </div>
        {% endif %}

        <!-- Speak buttons (browser TTS fallback) -->
        <div class="small-actions" style="margin-top:12px;">
          <button type="button" class="btn" onclick="speakEnglish()">ğŸ”Š Speak English</button>
          <button type="button" class="btn" onclick="speakOromo()">ğŸ”Š Speak Oromo</button>
        </div>

        <!-- Upload buttons (only when we have a real approved word id) -->
        {% if result_id %}
          <div class="small-actions" style="margin-top:12px;">
            <a class="btn" href="/upload_audio/word/{{ result_id }}/oromo">ğŸ™ Upload Oromo audio</a>
            <a class="btn" href="/upload_audio/word/{{ result_id }}/english">ğŸ™ Upload English audio</a>
          </div>
          <div class="muted" style="margin-top:8px; font-size:14px;">
            Audio becomes public after admin approval.
          </div>
        {% endif %}
      </div>

    {% elif result is not none %}
      <div class="result-box" style="margin-top:14px;">No exact match found.</div>
    {% endif %}

    {% if suggestions %}
      <div style="margin-top:14px;">
        <h2>Did you meanâ€¦</h2>

        {% if suggestions.en %}
          <div class="subtle">English suggestions</div>
          <div class="chips">
            {% for s in suggestions.en.closest %}<span class="chip" onclick="useSuggestion('{{ s|e }}')">{{ s }}</span>{% endfor %}
            {% for s in suggestions.en.prefix %}<span class="chip" onclick="useSuggestion('{{ s|e }}')">{{ s }}</span>{% endfor %}
            {% for s in suggestions.en.partial %}<span class="chip" onclick="useSuggestion('{{ s|e }}')">{{ s }}</span>{% endfor %}
          </div>
        {% endif %}

        {% if suggestions.om %}
          <div class="subtle" style="margin-top:10px;">Oromo suggestions</div>
          <div class="chips">
            {% for s in suggestions.om.closest %}<span class="chip" onclick="useSuggestion('{{ s|e }}')">{{ s }}</span>{% endfor %}
            {% for s in suggestions.om.prefix %}<span class="chip" onclick="useSuggestion('{{ s|e }}')">{{ s }}</span>{% endfor %}
            {% for s in suggestions.om.partial %}<span class="chip" onclick="useSuggestion('{{ s|e }}')">{{ s }}</span>{% endfor %}
          </div>
        {% endif %}
      </div>
    {% endif %}

    <div class="quick-actions">
      <a class="btn primary" href="/translate">ğŸŒ Translator</a>
      <a class="btn" href="/submit">â• Add Word</a>
      <a class="btn" href="/submit_phrase">â• Add Phrase</a>
    </div>
  </section>

  {% if trending %}
    <section class="card">
      <h2>ğŸ”¥ Trending Searches</h2>
      <div class="chips">
        {% for t in trending %}
          <span class="chip" onclick="useSuggestion('{{ t[0]|e }}')">{{ t[0] }} <span class="muted">({{ t[1] }})</span></span>
        {% endfor %}
      </div>
      <div class="subtle" style="margin-top:8px;">Tap a trending word to search it.</div>
    </section>
  {% endif %}

  <section class="card">
    <h2>Approved Words</h2>

    {% if words and words|length > 0 %}
      <div class="word-list">
        {% for w in words %}
          <div class="word-row">
            <span><b>{{ w[0] }}</b></span>
            <span class="muted">â†’</span>
            <span><b>{{ w[1] }}</b></span>
          </div>
        {% endfor %}
      </div>
    {% else %}
      <p class="muted">No approved words yet. Be the first to submit!</p>
    {% endif %}
  </section>

  <footer class="footer">
    <p>Â© 2026 GadaOromo â€” Open community dictionary</p>
  </footer>

</div>

<script>
function useSuggestion(text){
  const inp=document.getElementById("searchWord");
  if(inp) inp.value=text;
  document.getElementById("searchForm").submit();
}

/* ===== Speech-to-text for Dictionary Search ===== */
function startVoiceSearch(){
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SpeechRecognition){
    alert("Voice input not supported. Use Chrome on PC/Android.");
    return;
  }

  const recognition = new SpeechRecognition();
  // Most browsers don't support om-ET reliably; use en-US to still capture speech.
  recognition.lang = "en-US";
  recognition.interimResults = false;

  recognition.onresult = function(event){
    const text = event.results[0][0].transcript;
    document.getElementById("searchWord").value = text;
    document.getElementById("searchForm").submit();
  };

  recognition.onerror = function(e){
    alert("Voice input error: " + e.error);
  };

  recognition.start();
}

/* ===== Voice output fallback (Browser TTS) ===== */
let cachedVoices = [];
function loadVoices(){
  if(!('speechSynthesis' in window)) return;
  cachedVoices = window.speechSynthesis.getVoices() || [];
}
if ('speechSynthesis' in window) {
  loadVoices();
  window.speechSynthesis.onvoiceschanged = loadVoices;
}
function pickBestVoice(langCode){
  if(!cachedVoices || cachedVoices.length===0) return null;
  const lc=(langCode||"").toLowerCase();
  let v=cachedVoices.find(x => (x.lang||"").toLowerCase()===lc);
  if(v) return v;
  const base=lc.split("-")[0];
  v=cachedVoices.find(x => (x.lang||"").toLowerCase().startsWith(base));
  if(v) return v;
  v=cachedVoices.find(x => (x.lang||"").toLowerCase().startsWith("en"));
  return v || null;
}
function speakText(text, langCode){
  if(!('speechSynthesis' in window)) return alert("Speech is not supported in this browser.");
  if(!text || !text.trim()) return alert("Nothing to speak.");
  const u=new SpeechSynthesisUtterance(text);
  const best=pickBestVoice(langCode);
  if(best){
    u.voice=best;
    u.lang=best.lang;
  } else {
    u.lang=langCode;
  }
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}
function speakEnglish(){
  const el=document.getElementById("enText");
  const txt=el?el.innerText:"";
  speakText(txt, "en-US");
}
function speakOromo(){
  const el=document.getElementById("omText");
  const txt=el?el.innerText:"";
  speakText(txt, "om-ET");
}
</script>

</body>
</html>




