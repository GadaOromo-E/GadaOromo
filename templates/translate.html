<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Translator | {{ APP_NAME }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<div class="container">

  <!-- ===== Top Bar / Navigation ===== -->
  <div class="topbar">
    <div class="title-row" style="align-items:flex-start;">
      <div>
        <h2 style="margin:0;">üåç Oromo ‚Üî English Translator</h2>
        <div class="subtle">
          {% if direction == "om_en" %}Detected/Selected: Oromo ‚Üí English
          {% elif direction == "en_om" %}Detected/Selected: English ‚Üí Oromo
          {% else %}Detected/Selected: Auto{% endif %}
        </div>

        <!-- Simple nav (works on web + inside apps) -->
        <div class="small-actions" style="margin-top:10px;">
          <a class="btn" href="/">üè† Home</a>
          <a class="btn primary" href="/translate">üîÅ Translate</a>
          <a class="btn" href="/learn">üìö Learn</a>
          <a class="btn danger" href="/support">‚ù§Ô∏è Donate</a>
        </div>
      </div>
    </div>
  </div>

  <!-- ===== Donation info banner (NOK) ===== -->
  <section class="card" style="margin-top:14px;">
    <div style="display:flex; align-items:flex-start; justify-content:space-between; gap:14px; flex-wrap:wrap;">
      <div>
        <h2 style="margin-top:0;">‚ù§Ô∏è Support this free translator</h2>
        <div class="subtle">
          Minimum donation: <b>{{ SUPPORT_MIN_NOK }} NOK</b>.
          Supporters can donate <b>{{ SUPPORT_MIN_NOK }}, {{ SUPPORT_MIN_NOK * 2 }}, {{ SUPPORT_MIN_NOK * 3 }}‚Ä¶ NOK</b> by increasing quantity in Stripe.
        </div>
      </div>
      <div class="small-actions">
        <a class="btn danger" href="/support">Donate</a>
      </div>
    </div>
  </section>

  <div class="card">
    <form method="POST" id="translateForm">
      <div class="row">
        <select name="direction" id="directionSelect">
          <option value="auto" {% if direction == "auto" %}selected{% endif %}>Auto Detect</option>
          <option value="om_en" {% if direction == "om_en" %}selected{% endif %}>Oromo ‚Üí English</option>
          <option value="en_om" {% if direction == "en_om" %}selected{% endif %}>English ‚Üí Oromo</option>
        </select>

        <button type="button" onclick="startVoice()">üé§ Speak</button>
      </div>

      <textarea name="text" id="textInput" placeholder="Type word or sentence..." required oninput="autoGrow(this)">{{ text or "" }}</textarea>

      <div class="bottom-bar">
        <div class="bottom-actions">
          <button type="submit">Translate</button>
          <a class="btn" href="javascript:void(0)" onclick="speakInput()">üîä Speak Input</a>
        </div>
      </div>

      <div class="small-actions">
        <button type="button" class="btn" onclick="clearInput()">üßπ Clear</button>
        <button type="button" class="btn" onclick="swapDirection()">üîÅ Swap</button>
      </div>
    </form>

    {% if result %}
      <div class="result-box">
        <strong>Result:</strong> <span id="resultText">{{ result }}</span>
      </div>

      <div class="small-actions">
        <button type="button" class="btn" onclick="speakResult()">üîä Speak Result</button>
        <button type="button" class="btn" onclick="copyResult()">üìã Copy Result</button>
      </div>
    {% else %}
      <div class="result-box" style="opacity:0.85;">Result will appear here‚Ä¶</div>
    {% endif %}

    <!-- ===== Community Audio (approved) ===== -->
    {% if audio %}
      <div style="margin-top:14px;">
        <h2>üéß Community Pronunciation</h2>

        {% if audio.oromo %}
          <div class="subtle">Oromo audio</div>
          <audio controls>
            <source src="{{ url_for('static', filename=audio.oromo) }}">
          </audio>
        {% endif %}

        {% if audio.english %}
          <div class="subtle" style="margin-top:10px;">English audio</div>
          <audio controls>
            <source src="{{ url_for('static', filename=audio.english) }}">
          </audio>
        {% endif %}

        {% if not audio.oromo and not audio.english %}
          <div class="muted">No approved audio yet.</div>
        {% endif %}
      </div>
    {% endif %}

    <!-- ===== Inline Recording (only when exact match exists) ===== -->
    {% if matched %}
      <div style="margin-top:14px;">
        <h2>üéô Help the community</h2>
        <div class="muted" style="margin-top:6px;">
          Record Oromo pronunciation here. It becomes public after admin approval.
        </div>

        {# Hide mic if Oromo audio already approved for this matched entry #}
        {% set is_word = (matched.type == "word") %}
        {% set is_phrase = (matched.type == "phrase") %}

        {% set has_approved_oromo =
          (is_word and (matched.id in approved_oromo_audio_word_ids)) or
          (is_phrase and (matched.id in approved_oromo_audio_phrase_ids))
        %}

        {% if not has_approved_oromo %}
          <div class="small-actions" style="margin-top:10px;">
            <button
              type="button"
              class="btn primary"
              data-record-btn
              data-entry-type="{{ matched.type }}"
              data-entry-id="{{ matched.id }}"
              data-lang="oromo"
              title="Record Oromo pronunciation"
            >üéô Record Oromo</button>

            <button
              type="button"
              class="btn"
              data-stop-btn
              style="display:none;"
            >‚èπ Stop</button>
          </div>

          <audio data-preview-audio controls style="width:100%; display:none; margin-top:10px;"></audio>

          <div data-trim-box class="trim" style="display:none; margin-top:10px;">
            <div class="subtle" style="margin-bottom:6px;">Optional: trim before submitting</div>
            <label>Start (sec)
              <input data-trim-start type="number" min="0" step="0.1" value="0">
            </label>
            <label style="margin-left:8px;">End (sec)
              <input data-trim-end type="number" min="0" step="0.1" value="0">
            </label>
            <button type="button" class="btn" data-apply-trim>‚úÇÔ∏è Apply Trim</button>
          </div>

          <div class="small-actions" style="margin-top:10px;">
            <button type="button" class="btn primary" data-submit-btn style="display:none;">‚úÖ Submit</button>
            <button type="button" class="btn" data-rerecord-btn style="display:none;">üîÅ Re-record</button>
          </div>

          <div class="muted" data-status-for="{{ matched.type }}_{{ matched.id }}" style="margin-top:8px;"></div>
        {% else %}
          <div class="muted" style="margin-top:10px;">‚úÖ Oromo audio already approved for this {{ matched.type }}.</div>
        {% endif %}

        <div class="small-actions" style="margin-top:10px;">
          <a class="btn" href="/upload_audio/{{ matched.type }}/{{ matched.id }}/oromo">Upload Oromo audio (file)</a>
          <a class="btn" href="/upload_audio/{{ matched.type }}/{{ matched.id }}/english">Upload English audio (file)</a>
        </div>
      </div>
    {% endif %}

    {% if suggestions %}
      <div style="margin-top:14px;">
        <h2>Did you mean‚Ä¶</h2>

        {% if suggestions.closest and suggestions.closest|length > 0 %}
          <div class="subtle">Closest matches</div>
          <div class="chips">
            {% for s in suggestions.closest %}
              <span class="chip" onclick="useSuggestion('{{ s|e }}')">{{ s }}</span>
            {% endfor %}
          </div>
        {% endif %}

        {% if suggestions.prefix and suggestions.prefix|length > 0 %}
          <div class="subtle" style="margin-top:10px;">Starts with</div>
          <div class="chips">
            {% for s in suggestions.prefix %}
              <span class="chip" onclick="useSuggestion('{{ s|e }}')">{{ s }}</span>
            {% endfor %}
          </div>
        {% endif %}

        {% if suggestions.partial and suggestions.partial|length > 0 %}
          <div class="subtle" style="margin-top:10px;">Contains</div>
          <div class="chips">
            {% for s in suggestions.partial %}
              <span class="chip" onclick="useSuggestion('{{ s|e }}')">{{ s }}</span>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    {% endif %}

    {% if trending %}
      <div style="margin-top:14px;">
        <h2>üî• Trending</h2>
        <div class="chips">
          {% for row in trending %}
            <span class="chip" onclick="useSuggestion('{{ row[0]|e }}')">{{ row[0] }}</span>
          {% endfor %}
        </div>
      </div>
    {% endif %}

  </div>
</div>

<script>
/* YOUR ORIGINAL JS BLOCK (unchanged) */
function autoGrow(el){ el.style.height="auto"; el.style.height=(el.scrollHeight)+"px"; }
window.addEventListener("load", ()=>{ const ta=document.getElementById("textInput"); if(ta) autoGrow(ta); });

function useSuggestion(text){ const ta=document.getElementById("textInput"); ta.value=text; autoGrow(ta); document.getElementById("translateForm").submit(); }
function clearInput(){ const ta=document.getElementById("textInput"); ta.value=""; autoGrow(ta); ta.focus(); }
function swapDirection(){
  const sel=document.getElementById("directionSelect");
  if(sel.value==="om_en") sel.value="en_om";
  else if(sel.value==="en_om") sel.value="om_en";
  else sel.value="en_om";
}
function copyResult(){
  const el=document.getElementById("resultText");
  const txt=el?el.innerText:"";
  if(!txt) return alert("Nothing to copy.");
  navigator.clipboard.writeText(txt).then(()=>alert("Copied!")).catch(()=>alert("Copy failed."));
}

/* Voice output */
let cachedVoices = [];
function loadVoices(){ cachedVoices = window.speechSynthesis ? window.speechSynthesis.getVoices() : []; }
if ('speechSynthesis' in window) {
  loadVoices();
  window.speechSynthesis.onvoiceschanged = loadVoices;
}
function pickBestVoice(langCode){
  if(!cachedVoices || cachedVoices.length===0) return null;
  const lc=(langCode||"").toLowerCase();
  let v=cachedVoices.find(x => (x.lang||"").toLowerCase()===lc);
  if(v) return v;
  const base=lc.split("-")[0];
  v=cachedVoices.find(x => (x.lang||"").toLowerCase().startsWith(base));
  if(v) return v;
  v=cachedVoices.find(x => (x.lang||"").toLowerCase().startsWith("en"));
  return v || null;
}

function speakText(text, langCode){
  if(!('speechSynthesis' in window)) return alert("Speech is not supported in this browser.");
  if(!text || !text.trim()) return alert("Nothing to speak.");
  const u=new SpeechSynthesisUtterance(text);
  const best=pickBestVoice(langCode);
  if(best){ u.voice=best; u.lang=best.lang; } else { u.lang=langCode; }
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}

function speakInput(){
  const txt=document.getElementById("textInput").value;
  const dir=document.getElementById("directionSelect").value;
  const lang=(dir==="om_en") ? "om-ET" : "en-US";
  speakText(txt, lang);
}
function speakResult(){
  const el=document.getElementById("resultText");
  const txt=el?el.innerText:"";
  const dir=document.getElementById("directionSelect").value;
  const lang=(dir==="om_en") ? "en-US" : "om-ET";
  speakText(txt, lang);
}

/* Speech-to-text */
function startVoice(){
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SpeechRecognition) return alert("Voice input not supported. Use Chrome on PC/Android.");
  const recognition=new SpeechRecognition();
  const dir=document.getElementById("directionSelect").value;
  recognition.lang=(dir==="om_en") ? "om-ET" : "en-US";
  recognition.interimResults=false;

  recognition.onresult=function(event){
    const text=event.results[0][0].transcript;
    const ta=document.getElementById("textInput");
    ta.value=text; autoGrow(ta);
  };
  recognition.onerror=function(e){ alert("Voice input error: " + e.error); };
  recognition.start();
}

/* (rest of your original JS continues unchanged...) */
</script>

</body>
</html>







