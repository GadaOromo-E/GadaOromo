
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Translator | {{ APP_NAME }}</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

  <!-- âœ… PWA -->
  <link rel="manifest" href="{{ url_for('static', filename='manifest.webmanifest') }}">
  <meta name="theme-color" content="#0b5cff">

  <!-- âœ… iOS -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="default">
  <meta name="apple-mobile-web-app-title" content="{{ APP_NAME }}">
  <link rel="apple-touch-icon" href="{{ url_for('static', filename='icons/apple-touch-icon.png') }}">

  <link rel="icon" href="/static/icons/favicon.ico" sizes="any">
  <link rel="icon" type="image/png" sizes="32x32" href="/static/icons/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/static/icons/favicon-16x16.png">
  <link rel="apple-touch-icon" href="/static/icons/apple-touch-icon.png">
</head>
<body>

<div id="bootSplash" style="position:fixed; inset:0; background:#fff; display:flex; align-items:center; justify-content:center; z-index:2000;">
  <div style="text-align:center;">
    <div style="font-size:42px;">ğŸ“˜</div>
    <div style="margin-top:8px; font-weight:700;">{{ APP_NAME }}</div>
    <div class="muted" style="margin-top:6px;">Loadingâ€¦</div>
  </div>
</div>
<script>
  window.addEventListener("load", () => {
    const el = document.getElementById("bootSplash");
    if (el) el.style.display = "none";
  });
</script>

<div id="pwaUpdateBar" class="card" style="display:none; position:sticky; top:0; z-index:999; margin:0; border-radius:0;">
  <div style="display:flex; align-items:center; justify-content:space-between; gap:12px;">
    <div>
      <b>Update available</b>
      <div class="muted" style="font-size:14px;">Reload to get the latest version.</div>
    </div>
    <div style="display:flex; gap:8px;">
      <button class="btn primary" type="button" data-reload>Reload</button>
      <button class="btn" type="button" data-close>Later</button>
    </div>
  </div>
</div>

<div id="iosInstallHelp" class="card" style="display:none; margin-top:10px;">
  <b>Install on iPhone</b>
  <div class="muted" style="margin-top:6px; line-height:1.5;">
    Tap <b>Share</b> (â¬†ï¸) â†’ <b>Add to Home Screen</b>.
  </div>
</div>

<div id="pwaToast" class="card" style="display:none; position:fixed; left:12px; right:12px; bottom:12px; z-index:1000;">
  <span data-msg></span>
</div>

<div class="container">

  <div class="topbar">
    <div class="title-row" style="align-items:flex-start;">
      <div>
        <h2 style="margin:0;">ğŸŒ Oromo â†” English Translator</h2>
        <div class="subtle">
          {% if direction == "om_en" %}Detected/Selected: Oromo â†’ English
          {% elif direction == "en_om" %}Detected/Selected: English â†’ Oromo
          {% else %}Detected/Selected: Auto{% endif %}
        </div>

        <div class="small-actions" style="margin-top:10px; display:flex; flex-wrap:wrap; gap:8px;">
          <a class="btn" href="/">ğŸ  Home</a>
          <a class="btn primary" href="/translate">ğŸ” Translate</a>
          <a class="btn" href="/learn">ğŸ“š Learn</a>
          <a class="btn danger" href="/support">â¤ï¸ Support</a>
          <button id="installBtn" class="btn primary" type="button" style="display:none;">â¬‡ï¸ Install App</button>
        </div>
      </div>
    </div>
  </div>

  <div class="card">
    <form method="POST" id="translateForm">
      <div class="row">
        <select name="direction" id="directionSelect">
          <option value="auto" {% if direction == "auto" %}selected{% endif %}>Auto Detect</option>
          <option value="om_en" {% if direction == "om_en" %}selected{% endif %}>Oromo â†’ English</option>
          <option value="en_om" {% if direction == "en_om" %}selected{% endif %}>English â†’ Oromo</option>
        </select>

        <button type="button" onclick="startVoice()">ğŸ¤ Speak</button>
      </div>

      <textarea name="text" id="textInput" placeholder="Type word or sentence..." required oninput="autoGrow(this)">{{ text or "" }}</textarea>

      <div class="bottom-bar">
        <div class="bottom-actions">
          <button type="submit">Translate</button>
          <a class="btn" href="javascript:void(0)" onclick="speakInput()">ğŸ”Š Speak Input</a>
        </div>
      </div>

      <div class="small-actions">
        <button type="button" class="btn" onclick="clearInput()">ğŸ§¹ Clear</button>
        <button type="button" class="btn" onclick="swapDirection()">ğŸ” Swap</button>
      </div>
    </form>

    {% if result %}
      <div class="result-box">
        <strong>Result:</strong> <span id="resultText">{{ result }}</span>
      </div>

      <div class="small-actions">
        <button type="button" class="btn" onclick="speakResult()">ğŸ”Š Speak Result</button>
        <button type="button" class="btn" onclick="copyResult()">ğŸ“‹ Copy Result</button>
      </div>
    {% else %}
      <div class="result-box" style="opacity:0.85;">Result will appear hereâ€¦</div>
    {% endif %}

    <!-- ===== Community Audio (approved) ===== -->
    {% if audio and (audio.oromo or audio.english) %}
      <div style="margin-top:14px;">
        <h2>ğŸ§ Community Pronunciation</h2>

        {% if audio.oromo %}
          <div class="subtle">Oromo audio</div>
          <audio controls style="width:100%;">
            <source src="{{ audio.oromo }}">
          </audio>
        {% endif %}

        {% if audio.english %}
          <div class="subtle" style="margin-top:10px;">English audio</div>
          <audio controls style="width:100%;">
            <source src="{{ audio.english }}">
          </audio>
        {% endif %}
      </div>
    {% elif audio %}
      <div style="margin-top:14px;">
        <h2>ğŸ§ Community Pronunciation</h2>
        <div class="muted">No approved audio yet.</div>
      </div>
    {% endif %}

    <!-- ===== Inline Recording (public, ONLY when exact match exists) ===== -->
    {% if matched %}
      <div style="margin-top:14px;">
        <h2>ğŸ™ Help the community</h2>
        <div class="muted" style="margin-top:6px;">
          Record Oromo pronunciation here. It becomes public after admin approval.
        </div>

        {% set is_word = (matched.type == "word") %}
        {% set is_phrase = (matched.type == "phrase") %}

        {% set has_approved_oromo =
          (is_word and (matched.id in approved_oromo_audio_word_ids)) or
          (is_phrase and (matched.id in approved_oromo_audio_phrase_ids))
        %}

        {% if not has_approved_oromo %}
          <!-- âœ… Put entry info on the widget container so audio.js always works -->
          <div class="card" style="margin-top:10px;"
               data-entry-type="{{ matched.type }}"
               data-entry-id="{{ matched.id }}"
               data-lang="oromo">

            <div class="small-actions" style="margin-top:6px;">
              <button
                type="button"
                class="btn primary"
                data-record-btn
                data-entry-type="{{ matched.type }}"
                data-entry-id="{{ matched.id }}"
                data-lang="oromo"
                title="Record Oromo pronunciation"
              >ğŸ™ Record Oromo</button>

              <button
                type="button"
                class="btn"
                data-stop-btn
                data-entry-type="{{ matched.type }}"
                data-entry-id="{{ matched.id }}"
                data-lang="oromo"
                style="display:none;"
              >â¹ Stop</button>
            </div>

            <audio data-preview-audio controls style="width:100%; display:none; margin-top:10px;"></audio>

            <div class="small-actions" style="margin-top:10px;">
              <button
                type="button"
                class="btn primary"
                data-submit-btn
                data-entry-type="{{ matched.type }}"
                data-entry-id="{{ matched.id }}"
                data-lang="oromo"
                style="display:none;"
              >âœ… Submit</button>

              <button
                type="button"
                class="btn"
                data-rerecord-btn
                data-entry-type="{{ matched.type }}"
                data-entry-id="{{ matched.id }}"
                data-lang="oromo"
                style="display:none;"
              >ğŸ” Re-record</button>
            </div>

            <!-- status compatible with audio.js -->
            <div class="muted" data-status style="margin-top:8px;"></div>
          </div>
        {% else %}
          <div class="muted" style="margin-top:10px;">âœ… Oromo audio already approved for this {{ matched.type }}.</div>
        {% endif %}

        <div class="small-actions" style="margin-top:10px;">
          <a class="btn" href="/upload_audio/{{ matched.type }}/{{ matched.id }}/oromo">Upload Oromo audio (file)</a>
        </div>
      </div>
    {% endif %}

    {% if suggestions %}
      <div style="margin-top:14px;">
        <h2>Did you meanâ€¦</h2>

        {% if suggestions.closest and suggestions.closest|length > 0 %}
          <div class="subtle">Closest matches</div>
          <div class="chips">
            {% for s in suggestions.closest %}
              <span class="chip" onclick="useSuggestion('{{ s|e }}')">{{ s }}</span>
            {% endfor %}
          </div>
        {% endif %}

        {% if suggestions.prefix and suggestions.prefix|length > 0 %}
          <div class="subtle" style="margin-top:10px;">Starts with</div>
          <div class="chips">
            {% for s in suggestions.prefix %}
              <span class="chip" onclick="useSuggestion('{{ s|e }}')">{{ s }}</span>
            {% endfor %}
          </div>
        {% endif %}

        {% if suggestions.partial and suggestions.partial|length > 0 %}
          <div class="subtle" style="margin-top:10px;">Contains</div>
          <div class="chips">
            {% for s in suggestions.partial %}
              <span class="chip" onclick="useSuggestion('{{ s|e }}')">{{ s }}</span>
            {% endfor %}
          </div>
        {% endif %}
      </div>
    {% endif %}

    {% if trending %}
      <div style="margin-top:14px;">
        <h2>ğŸ”¥ Trending</h2>
        <div class="chips">
          {% for row in trending %}
            <span class="chip" onclick="useSuggestion('{{ row[0]|e }}')">{{ row[0] }}</span>
          {% endfor %}
        </div>
      </div>
    {% endif %}

  </div>
</div>

<script>
function autoGrow(el){ el.style.height="auto"; el.style.height=(el.scrollHeight)+"px"; }
window.addEventListener("load", ()=>{ const ta=document.getElementById("textInput"); if(ta) autoGrow(ta); });

function useSuggestion(text){ const ta=document.getElementById("textInput"); ta.value=text; autoGrow(ta); document.getElementById("translateForm").submit(); }
function clearInput(){ const ta=document.getElementById("textInput"); ta.value=""; autoGrow(ta); ta.focus(); }
function swapDirection(){
  const sel=document.getElementById("directionSelect");
  if(sel.value==="om_en") sel.value="en_om";
  else if(sel.value==="en_om") sel.value="om_en";
  else sel.value="en_om";
}
function copyResult(){
  const el=document.getElementById("resultText");
  const txt=el?el.innerText:"";
  if(!txt) return alert("Nothing to copy.");
  navigator.clipboard.writeText(txt).then(()=>alert("Copied!")).catch(()=>alert("Copy failed."));
}

let cachedVoices = [];
function loadVoices(){ cachedVoices = window.speechSynthesis ? window.speechSynthesis.getVoices() : []; }
if ('speechSynthesis' in window) {
  loadVoices();
  window.speechSynthesis.onvoiceschanged = loadVoices;
}
function pickBestVoice(langCode){
  if(!cachedVoices || cachedVoices.length===0) return null;
  const lc=(langCode||"").toLowerCase();
  let v=cachedVoices.find(x => (x.lang||"").toLowerCase()===lc);
  if(v) return v;
  const base=lc.split("-")[0];
  v=cachedVoices.find(x => (x.lang||"").toLowerCase().startsWith(base));
  if(v) return v;
  v=cachedVoices.find(x => (x.lang||"").toLowerCase().startsWith("en"));
  return v || null;
}

function speakText(text, langCode){
  if(!('speechSynthesis' in window)) return alert("Speech is not supported in this browser.");
  if(!text || !text.trim()) return alert("Nothing to speak.");
  const u=new SpeechSynthesisUtterance(text);
  const best=pickBestVoice(langCode);
  if(best){ u.voice=best; u.lang=best.lang; } else { u.lang=langCode; }
  window.speechSynthesis.cancel();
  window.speechSynthesis.speak(u);
}

function speakInput(){
  const txt=document.getElementById("textInput").value;
  const dir=document.getElementById("directionSelect").value;
  const lang=(dir==="om_en") ? "om-ET" : "en-US";
  speakText(txt, lang);
}
function speakResult(){
  const el=document.getElementById("resultText");
  const txt=el?el.innerText:"";
  const dir=document.getElementById("directionSelect").value;
  const lang=(dir==="om_en") ? "en-US" : "om-ET";
  speakText(txt, lang);
}

function startVoice(){
  const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
  if(!SpeechRecognition) return alert("Voice input not supported. Use Chrome on PC/Android.");
  const recognition=new SpeechRecognition();
  const dir=document.getElementById("directionSelect").value;
  recognition.lang=(dir==="om_en") ? "om-ET" : "en-US";
  recognition.interimResults=false;

  recognition.onresult=function(event){
    const text=event.results[0][0].transcript;
    const ta=document.getElementById("textInput");
    ta.value=text; autoGrow(ta);
  };
  recognition.onerror=function(e){ alert("Voice input error: " + e.error); };
  recognition.start();
}
</script>

<script src="{{ url_for('static', filename='pwa-ui.js') }}"></script>
<script src="{{ url_for('static', filename='audio.js') }}?v=20260120"></script>
<a class="btn" href="/recorder">ğŸ™ Add Voice</a>

</body>
</html>









